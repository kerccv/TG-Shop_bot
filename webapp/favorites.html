<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ - Lavander Shop</title>
  <link rel="stylesheet" href="./public/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <header>
    <div>
      <h1>Lavander Shop <i class="fas fa-bed"></i></h1>
      <p>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</p>
    </div>
    <div style="display: flex; gap: 1rem;">
      <a href="./favorites.html" class="cart-icon"><i class="fas fa-heart"></i><span class="cart-count" id="favorites-count">0</span></a>
      <a href="./cart.html" class="cart-icon"><i class="fas fa-shopping-cart"></i><span class="cart-count" id="cart-count">0</span></a>
    </div>
  </header>

  <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –≤–∏–¥ —Ç–æ–≤–∞—Ä–∞ -->
  <div id="product-fullscreen" class="product-fullscreen"></div>

  <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
  <main>
    <div class="filters-header">
      <span class="results-count" id="results-count">–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: 0</span>
      <div class="filter-sort-container">
        <div class="filter-button" onclick="toggleFilters()">
          <i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä—ã
        </div>
        <div class="sort-container">
          <i class="fas fa-sort"></i>
          <select id="sort-filter" onchange="sortProducts()">
            <option value="default">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
            <option value="price-asc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
            <option value="price-desc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
          </select>
        </div>
      </div>
    </div>

    <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ –æ–∫–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div id="filters-overlay" class="filters-overlay" onclick="closeFilters()"></div>
    <div id="filters-panel" class="filters-panel">
      <button class="filters-close" onclick="closeFilters()"><i class="fas fa-times"></i></button>
      <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
      <div id="filter-groups"></div>
      <button class="apply-filters" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>

    <div id="products-container"></div>
    <div class="pagination" id="pagination"></div>
  </main>

  <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <footer>
    <p>¬© 2025 Lavander Shop</p>
  </footer>

  <script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    let allProducts = favorites;
    let filteredProducts = [];
    const ITEMS_PER_PAGE = 15;
    let currentPage = 1;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    function initializeCartAndFavorites() {
      cart = cart.map(item => ({ ...item, quantity: item.quantity || 1 }));
      localStorage.setItem('cart', JSON.stringify(cart));
      favorites = favorites.map(item => ({ ...item }));
      localStorage.setItem('favorites', JSON.stringify(favorites));
      updateCartCount();
      updateFavoritesCount();
      filteredProducts = [...favorites];
      renderFilters();
      renderPage(1);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
    function updateCartCount() {
      const cartCount = document.getElementById('cart-count');
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      cartCount.textContent = totalItems;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    function updateFavoritesCount() {
      const favoritesCount = document.getElementById('favorites-count');
      favoritesCount.textContent = favorites.length;
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    function toggleFavorite(product, button) {
      const index = favorites.findIndex(item => item.id === product.id);
      if (index === -1) {
        favorites.push(product);
        button.classList.add('favorited');
      } else {
        favorites.splice(index, 1);
        button.classList.remove('favorited');
        allProducts = favorites;
        filteredProducts = [...favorites];
        renderPage(currentPage);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      updateFavoritesCount();
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
    function addToCart(product, button) {
      const existingItem = cart.find(item => item.id === product.id);
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ ...product, quantity: 1 });
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();

      const cartIcon = document.querySelector('.cart-icon');
      const clonedImage = button.closest('.product-card').querySelector('.product-image, .product-image-placeholder').cloneNode(true);
      document.body.appendChild(clonedImage);
      const rect = button.getBoundingClientRect();
      const cartRect = cartIcon.getBoundingClientRect();
      clonedImage.style.position = 'fixed';
      clonedImage.style.top = `${rect.top}px`;
      clonedImage.style.left = `${rect.left}px`;
      clonedImage.style.width = `${rect.width}px`;
      clonedImage.style.height = `${rect.height}px`;
      clonedImage.style.zIndex = '1000';
      clonedImage.style.transition = 'all 0.5s ease-in-out';
      setTimeout(() => {
        clonedImage.style.top = `${cartRect.top}px`;
        clonedImage.style.left = `${cartRect.left}px`;
        clonedImage.style.width = '20px';
        clonedImage.style.height = '20px';
        clonedImage.style.opacity = '0';
      }, 10);
      setTimeout(() => clonedImage.remove(), 500);
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
    function filterProducts() {
      const selectedTags = Array.from(document.querySelectorAll('.filter-option input:checked')).map(input => input.value.toLowerCase());
      const priceRange = {
        min: parseFloat(document.getElementById('price-min')?.value || 0),
        max: parseFloat(document.getElementById('price-max')?.value || Infinity)
      };
      filteredProducts = allProducts.filter(product => {
        const tags = product.tags ? product.tags.map(tag => tag.toLowerCase()) : [];
        const matchesTags = selectedTags.length === 0 || selectedTags.every(tag => tags.includes(tag));
        const matchesPrice = product.price >= priceRange.min && product.price <= priceRange.max;
        return matchesTags && matchesPrice;
      });
      renderPage(1);
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    function sortProducts() {
      const sortFilter = document.getElementById('sort-filter').value;
      let sortedProducts = [...filteredProducts];
      if (sortFilter === 'price-asc') {
        sortedProducts.sort((a, b) => a.price - b.price);
      } else if (sortFilter === 'price-desc') {
        sortedProducts.sort((a, b) => b.price - a.price);
      }
      filteredProducts = sortedProducts;
      renderPage(currentPage);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤
    function renderPage(page) {
      currentPage = page;
      const start = (page - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const productsToShow = filteredProducts.slice(start, end);

      const productsContainer = document.getElementById('products-container');
      productsContainer.innerHTML = '';
      document.getElementById('results-count').textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${filteredProducts.length}`;

      if (productsToShow.length === 0) {
        productsContainer.innerHTML = `
          <div class="text-center py-4">
            <p>–í—ã –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ üòî</p>
          </div>
        `;
        return;
      }

      productsToShow.forEach(product => {
        const productCard = document.createElement('a');
        productCard.href = `#product-${product.id}`;
        productCard.className = 'product-card';
        const images = product.image_url ? product.image_url.split(',') : [];
        const firstImage = images[0] || '';
        const imageContent = firstImage
          ? `<img src="${firstImage}" alt="${product.name}" class="product-image">`
          : `<div class="product-image-placeholder"><span><i class="fas fa-image"></i></span></div>`;
        const isFavorited = favorites.some(item => item.id === product.id);
        productCard.innerHTML = `
          ${imageContent}
          <div class="product-info">
            <span class="product-price">${product.price} –≥—Ä–Ω</span>
            <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="event.preventDefault(); toggleFavorite(${JSON.stringify(product)}, this)">
              <i class="fas fa-heart"></i>
            </button>
          </div>
        `;
        productCard.addEventListener('click', (e) => {
          if (e.target.closest('.favorite-btn')) return;
          e.preventDefault();
          openProductFullscreen(product);
        });
        productsContainer.appendChild(productCard);
      });

      renderPagination();
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function renderPagination() {
      const totalPages = Math.ceil(filteredProducts.length / ITEMS_PER_PAGE);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement('button');
        button.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        button.textContent = i;
        button.onclick = () => renderPage(i);
        pagination.appendChild(button);
      }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function renderFilters() {
      const tags = [...new Set(allProducts.flatMap(p => p.tags || []))];
      const prices = allProducts.map(p => p.price);
      const minPrice = prices.length ? Math.min(...prices) : 0;
      const maxPrice = prices.length ? Math.max(...prices) : 0;

      const filterGroups = document.getElementById('filter-groups');
      filterGroups.innerHTML = `
        <div class="filter-group">
          <h3>–¢–µ–≥–∏</h3>
          ${tags.length ? tags.map(tag => `
            <div class="filter-option">
              <input type="checkbox" value="${tag}" id="tag-${tag}">
              <label for="tag-${tag}">${tag}</label>
            </div>
          `).join('') : '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–≥–æ–≤</p>'}
        </div>
        <div class="filter-group">
          <h3>–¶–µ–Ω–∞</h3>
          <div>
            <label for="price-min">–û—Ç:</label>
            <input type="number" id="price-min" value="${minPrice}" min="${minPrice}" max="${maxPrice}">
          </div>
          <div>
            <label for="price-max">–î–æ:</label>
            <input type="number" id="price-max" value="${maxPrice}" min="${minPrice}" max="${maxPrice}">
          </div>
        </div>
      `;
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function toggleFilters() {
      const overlay = document.getElementById('filters-overlay');
      const panel = document.getElementById('filters-panel');
      overlay.style.display = 'flex';
      panel.style.display = 'block';
    }

    function closeFilters() {
      const overlay = document.getElementById('filters-overlay');
      const panel = document.getElementById('filters-panel');
      overlay.style.display = 'none';
      panel.style.display = 'none';
    }

    function applyFilters() {
      filterProducts();
      closeFilters();
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ —Ç–æ–≤–∞—Ä–∞
    function openProductFullscreen(product) {
      const fullscreen = document.getElementById('product-fullscreen');
      const images = product.image_url ? product.image_url.split(',') : [];
      const firstImage = images[0] || '';
      let currentImageIndex = 0;

      const imageContent = firstImage
        ? `<img src="${firstImage}" alt="${product.name}" class="gallery-image">`
        : `<div class="product-image-placeholder"><span><i class="fas fa-image"></i></span></div>`;

      const tagsContent = product.tags && product.tags.length
        ? product.tags.map(tag => `<span class="tag">${tag}</span>`).join('')
        : '–ù–µ—Ç —Ç–µ–≥–æ–≤';

      fullscreen.innerHTML = `
        <button class="back-button" onclick="closeProductFullscreen()"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
        <div class="image-gallery">
          ${imageContent}
          ${images.length > 1 ? `
            <button class="gallery-nav prev" onclick="changeImage(-1)">‚Üê</button>
            <button class="gallery-nav next" onclick="changeImage(1)">‚Üí</button>
          ` : ''}
        </div>
        <div class="product-info-full">
          <h2>${product.name}</h2>
          <p class="price">${product.price} –≥—Ä–Ω</p>
          <div class="quantity-control">
            <button onclick="changeQuantity(-1)">-</button>
            <span id="quantity">1</span>
            <button onclick="changeQuantity(1)">+</button>
          </div>
          <p class="description">${product.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
          <div class="tags">${tagsContent}</div>
          <div class="product-buttons">
            <button class="product-button" data-product='${JSON.stringify(product)}'>–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
            <button class="buy-now-button" onclick="buyNow('${product.name}')">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
          </div>
        </div>
      `;
      fullscreen.style.display = 'block';

      fullscreen.querySelectorAll('.product-button').forEach(button => {
        button.addEventListener('click', () => {
          const prod = JSON.parse(button.getAttribute('data-product'));
          prod.quantity = parseInt(document.getElementById('quantity').textContent);
          addToCart(prod, button);
        });
      });

      window.changeImage = (direction) => {
        currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
        const galleryImage = fullscreen.querySelector('.gallery-image');
        galleryImage.src = images[currentImageIndex];
      };

      window.changeQuantity = (change) => {
        const quantitySpan = document.getElementById('quantity');
        let quantity = parseInt(quantitySpan.textContent);
        quantity = Math.max(1, quantity + change);
        quantitySpan.textContent = quantity;
      };
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞
    function closeProductFullscreen() {
      const fullscreen = document.getElementById('product-fullscreen');
      fullscreen.style.display = 'none';
    }

    // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–∫—É–ø–∫–∏
    function buyNow(productName) {
      alert(`–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É ${productName}! –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ.`);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = initializeCartAndFavorites;
  </script>
</body>
</html>