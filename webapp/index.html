<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lavander Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./public/styles.css">
</head>
<body>
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <header>
    <h1>Lavander Shop üõí</h1>
    <p>–ú–∞–≥–∞–∑–∏–Ω –ø–æ—Å—Ç–µ–ª—å–Ω–æ–≥–æ –±–µ–ª—å—è</p>
    <div class="cart-icon" onclick="toggleCart()">üõí<span class="cart-count" id="cart-count">0</span></div>
    <div id="cart" class="cart">
      <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
      <div id="cart-items"></div>
    </div>
  </header>

  <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
  <main>
    <div class="filters">
      <select id="category-filter" onchange="filterProducts()">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      </select>
      <select id="sort-filter" onchange="sortProducts()">
        <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
        <option value="price-asc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
        <option value="price-desc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
      </select>
      <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="filterProducts()">
    </div>

    <div id="products-container">
      <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å —á–µ—Ä–µ–∑ JS -->
    </div>
  </main>

  <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <footer>
    <p>¬© 2025 Lavander Shop</p>
  </footer>

  <script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
    function toggleCart() {
      const cartDiv = document.getElementById('cart');
      cartDiv.style.display = cartDiv.style.display === 'block' ? 'none' : 'block';
      updateCart();
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
    function addToCart(product) {
      cart.push(product);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
    function removeFromCart(index) {
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    function updateCart() {
      const cartCount = document.getElementById('cart-count');
      const cartItems = document.getElementById('cart-items');
      cartCount.textContent = cart.length;
      cartItems.innerHTML = '';
      cart.forEach((item, index) => {
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
          ${item.name} - ${item.price} –≥—Ä–Ω
          <button onclick="removeFromCart(${index})">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        cartItems.appendChild(cartItem);
      });
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    let allProducts = [];

    async function loadProducts() {
      try {
        const response = await fetch('/api/products');
        allProducts = await response.json();

        const productsContainer = document.getElementById('products-container');
        productsContainer.innerHTML = '';

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const categories = [...new Set(allProducts.map(p => p.category))];
        const categoryFilter = document.getElementById('category-filter');
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categoryFilter.appendChild(option);
        });

        if (allProducts.length === 0) {
          productsContainer.innerHTML = `
            <div class="product-card col-span-2 text-center py-4">
              <p>–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç üòî</p>
            </div>
          `;
          return;
        }

        filterProducts(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å—Ä–∞–∑—É
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
        document.getElementById('products-container').innerHTML = `
          <div class="product-card col-span-2 text-center text-red-600 py-4">
            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ${error.message}</p>
          </div>
        `;
      }
    }

    function filterProducts() {
      const categoryFilter = document.getElementById('category-filter').value;
      const searchInput = document.getElementById('search-input').value.toLowerCase();
      let filteredProducts = allProducts.filter(product => {
        const matchesCategory = !categoryFilter || product.category === categoryFilter;
        const matchesSearch = !searchInput || product.name.toLowerCase().includes(searchInput);
        return matchesCategory && matchesSearch;
      });
      sortProducts(filteredProducts);
    }

    function sortProducts(filteredProducts = allProducts) {
      const sortFilter = document.getElementById('sort-filter').value;
      let sortedProducts = [...filteredProducts];
      if (sortFilter === 'price-asc') {
        sortedProducts.sort((a, b) => a.price - b.price);
      } else if (sortFilter === 'price-desc') {
        sortedProducts.sort((a, b) => b.price - a.price);
      }
      renderProducts(sortedProducts);
    }

    function renderProducts(products) {
      const productsContainer = document.getElementById('products-container');
      productsContainer.innerHTML = '';
      products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        const imageSrc = product.image_url ? product.image_url : '';
        const imageContent = imageSrc
          ? `<img src="${imageSrc}" alt="${product.name}" class="product-image">`
          : `<div class="product-image-placeholder"><span>üì∑ –ù–µ—Ç —Ñ–æ—Ç–æ</span></div>`;
        productCard.innerHTML = `
          ${imageContent}
          <h3 class="product-title">${product.name}</h3>
          <p class="product-description">${product.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
          <p class="product-price">${product.price} –≥—Ä–Ω</p>
          <p class="product-stock">–û—Å—Ç–∞—Ç–æ–∫: ${product.stock}</p>
          <div class="product-buttons">
            <button class="product-button" onclick="addToCart(${JSON.stringify(product)})">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
            <button class="buy-now-button" onclick="buyNow('${product.name}')">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
          </div>
        `;
        productsContainer.appendChild(productCard);
      });
    }

    // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–∫—É–ø–∫–∏
    function buyNow(productName) {
      alert(`–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É ${productName}! –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ.`);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = loadProducts;
  </script>
</body>
</html>
