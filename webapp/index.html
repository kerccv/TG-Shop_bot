<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lavander Shop</title>
  <link rel="stylesheet" href="./public/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <header>
    <div>
      <h1>Lavander Shop üõí</h1>
      <p>–ú–∞–≥–∞–∑–∏–Ω –ø–æ—Å—Ç–µ–ª—å–Ω–æ–≥–æ –±–µ–ª—å—è</p>
    </div>
    <a href="./cart.html" class="cart-icon">üõí<span class="cart-count" id="cart-count">0</span></a>
  </header>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ -->
  <div id="image-modal" class="image-modal">
    <span class="close-image" onclick="closeImageModal()">‚úï</span>
    <img id="modal-image" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">
  </div>

  <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –≤–∏–¥ —Ç–æ–≤–∞—Ä–∞ -->
  <div id="product-fullscreen" class="product-fullscreen"></div>

  <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
  <main>
    <div class="filters">
      <div class="filter-container">
        <select id="category-filter" onchange="filterProducts()">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        </select>
      </div>
      <div class="filter-container">
        <select id="sort-filter" onchange="sortProducts()">
          <option value="default">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
          <option value="price-asc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
          <option value="price-desc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
        </select>
      </div>
      <div class="filter-container search">
        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="filterProducts()">
      </div>
    </div>

    <div id="products-container">
      <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å —á–µ—Ä–µ–∑ JS -->
    </div>
  </main>

  <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <footer>
    <p>¬© 2025 Lavander Shop</p>
  </footer>

  <script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let allProducts = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã
    function initializeCart() {
      cart = cart.map(item => ({ ...item, quantity: item.quantity || 1 }));
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
    function updateCartCount() {
      const cartCount = document.getElementById('cart-count');
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      cartCount.textContent = totalItems;
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    function addToCart(product, button) {
      const existingItem = cart.find(item => item.id === product.id);
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ ...product, quantity: 1 });
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();

      // –ê–Ω–∏–º–∞—Ü–∏—è "–ø–æ–ª—ë—Ç–∞" –≤ –∫–æ—Ä–∑–∏–Ω—É
      const cartIcon = document.querySelector('.cart-icon');
      const clonedImage = button.closest('.product-card').querySelector('.product-image, .product-image-placeholder').cloneNode(true);
      document.body.appendChild(clonedImage);
      const rect = button.getBoundingClientRect();
      const cartRect = cartIcon.getBoundingClientRect();
      clonedImage.style.position = 'fixed';
      clonedImage.style.top = `${rect.top}px`;
      clonedImage.style.left = `${rect.left}px`;
      clonedImage.style.width = `${rect.width}px`;
      clonedImage.style.height = `${rect.height}px`;
      clonedImage.style.zIndex = '1000';
      clonedImage.style.transition = 'all 0.5s ease-in-out';
      setTimeout(() => {
        clonedImage.style.top = `${cartRect.top}px`;
        clonedImage.style.left = `${cartRect.left}px`;
        clonedImage.style.width = '20px';
        clonedImage.style.height = '20px';
        clonedImage.style.opacity = '0';
      }, 10);
      setTimeout(() => clonedImage.remove(), 500);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    async function loadProducts() {
      try {
        const response = await fetch('/api/products');
        allProducts = await response.json();

        const productsContainer = document.getElementById('products-container');
        productsContainer.innerHTML = '';

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const categories = [...new Set(allProducts.map(p => p.category))];
        const categoryFilter = document.getElementById('category-filter');
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categoryFilter.appendChild(option);
        });

        if (allProducts.length === 0) {
          productsContainer.innerHTML = `
            <div class="product-card col-span-2 text-center py-4">
              <p>–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç üòî</p>
            </div>
          `;
          return;
        }

        filterProducts();
        initializeCart();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
        document.getElementById('products-container').innerHTML = `
          <div class="product-card col-span-2 text-center text-red-600 py-4">
            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ${error.message}</p>
          </div>
        `;
      }
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
    function filterProducts() {
      const categoryFilter = document.getElementById('category-filter').value;
      const searchInput = document.getElementById('search-input').value.toLowerCase();
      let filteredProducts = allProducts.filter(product => {
        const matchesCategory = !categoryFilter || product.category === categoryFilter;
        const matchesSearch = !searchInput || product.name.toLowerCase().includes(searchInput);
        return matchesCategory && matchesSearch;
      });
      sortProducts(filteredProducts);
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    function sortProducts(filteredProducts = allProducts) {
      const sortFilter = document.getElementById('sort-filter').value;
      let sortedProducts = [...filteredProducts];
      if (sortFilter === 'price-asc') {
        sortedProducts.sort((a, b) => a.price - b.price);
      } else if (sortFilter === 'price-desc') {
        sortedProducts.sort((a, b) => b.price - a.price);
      }
      renderProducts(sortedProducts);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    function renderProducts(products) {
      const productsContainer = document.getElementById('products-container');
      productsContainer.innerHTML = '';
      products.forEach(product => {
        const productCard = document.createElement('a');
        productCard.href = `#product-${product.id}`;
        productCard.className = 'product-card';
        const images = product.image_url ? product.image_url.split(',') : [];
        const firstImage = images[0] || '';
        const imageContent = firstImage
          ? `<img src="${firstImage}" alt="${product.name}" class="product-image">`
          : `<div class="product-image-placeholder"><span>üì∑ –ù–µ—Ç —Ñ–æ—Ç–æ</span></div>`;
        productCard.innerHTML = `
          ${imageContent}
          <h3 class="product-title">${product.name}</h3>
          <p class="product-price">${product.price} –≥—Ä–Ω</p>
          <p class="product-stock">–û—Å—Ç–∞—Ç–æ–∫: ${product.stock}</p>
          <p class="product-details">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ</p>
        `;
        productCard.addEventListener('click', (e) => {
          e.preventDefault();
          openProductFullscreen(product);
        });
        productsContainer.appendChild(productCard);
      });
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ —Ç–æ–≤–∞—Ä–∞
    function openProductFullscreen(product) {
      const fullscreen = document.getElementById('product-fullscreen');
      const images = product.image_url ? product.image_url.split(',') : [];
      const firstImage = images[0] || '';
      let currentImageIndex = 0;

      const imageContent = firstImage
        ? `<img src="${firstImage}" alt="${product.name}" class="gallery-image" onclick="openImageModal('${firstImage}')">`
        : `<div class="product-image-placeholder"><span>üì∑ –ù–µ—Ç —Ñ–æ—Ç–æ</span></div>`;

      const tagsContent = product.tags && product.tags.length
        ? product.tags.map(tag => `<span class="tag">${tag}</span>`).join('')
        : '–ù–µ—Ç —Ç–µ–≥–æ–≤';

      fullscreen.innerHTML = `
        <button class="back-button" onclick="closeProductFullscreen()">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="image-gallery">
          ${imageContent}
          ${images.length > 1 ? `
            <button class="gallery-nav prev" onclick="changeImage(-1)">‚Üê</button>
            <button class="gallery-nav next" onclick="changeImage(1)">‚Üí</button>
          ` : ''}
        </div>
        <div class="product-info">
          <h2>${product.name}</h2>
          <p class="price">${product.price} –≥—Ä–Ω</p>
          <div class="quantity-control">
            <button onclick="changeQuantity(-1)">-</button>
            <span id="quantity">1</span>
            <button onclick="changeQuantity(1)">+</button>
          </div>
          <p class="description">${product.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
          <div class="tags">${tagsContent}</div>
          <div class="product-buttons">
            <button class="product-button" data-product='${JSON.stringify(product)}'>–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
            <button class="buy-now-button" onclick="buyNow('${product.name}')">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
          </div>
        </div>
      `;
      fullscreen.style.display = 'block';

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
      fullscreen.querySelectorAll('.product-button').forEach(button => {
        button.addEventListener('click', () => {
          const prod = JSON.parse(button.getAttribute('data-product'));
          prod.quantity = parseInt(document.getElementById('quantity').textContent);
          addToCart(prod, button);
        });
      });

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ª–∏—Å—Ç–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      window.changeImage = (direction) => {
        currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
        const galleryImage = fullscreen.querySelector('.gallery-image');
        galleryImage.src = images[currentImageIndex];
        galleryImage.onclick = () => openImageModal(images[currentImageIndex]);
      };

      // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
      window.changeQuantity = (change) => {
        const quantitySpan = document.getElementById('quantity');
        let quantity = parseInt(quantitySpan.textContent);
        quantity = Math.max(1, quantity + change);
        quantitySpan.textContent = quantity;
      };
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞
    function closeProductFullscreen() {
      const fullscreen = document.getElementById('product-fullscreen');
      fullscreen.style.display = 'none';
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ
    function openImageModal(imageSrc) {
      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');
      modalImage.src = imageSrc;
      modal.style.display = 'flex';
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ
    function closeImageModal() {
      const modal = document.getElementById('image-modal');
      modal.style.display = 'none';
    }

    // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–∫—É–ø–∫–∏
    function buyNow(productName) {
      alert(`–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É ${productName}! –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ.`);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = loadProducts;
  </script>
</body>
</html>